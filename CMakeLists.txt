cmake_minimum_required(VERSION 3.7)

set(PROJECT_NAME nes)
project(${PROJECT_NAME})

if(${CMAKE_SYSTEM_NAME} MATCHES "Emscripten")
  set(CMAKE_C_COMPILER "emcc")
  set(WASM 1)
endif()

if(DEFINED TEST AND NOT DEFINED WASM)
  add_definitions(-DTEST)
endif()

if(NOT DEFINED LOG_LEVEL)
  add_definitions(-DLOG_LEVEL=0)
else()
  if("${LOG_LEVEL}" STREQUAL "TRACE")
    add_definitions(-DLOG_LEVEL=4)
  elseif("${LOG_LEVEL}" STREQUAL "DEBUG")
    add_definitions(-DLOG_LEVEL=3)
  elseif("${LOG_LEVEL}" STREQUAL "OFF")
    add_definitions(-DLOG_LEVEL=0)
  else()
    message(FATAL_ERROR "Invalid LOG_LEVEL ${LOG_LEVEL}, excepted TRACE, DEBUG or OFF!")
  endif()
endif()

if(DEFINED DEBUG AND "${DEBUG}" STREQUAL "ON")
  add_definitions(-DDEBUG)
else()
  set(DEBUG "OFF")
endif()

message(STATUS "SYSTEM                    " ${CMAKE_SYSTEM_NAME})
message(STATUS "COMPILER                  " ${CMAKE_C_COMPILER})
message(STATUS "LOG_LEVEL                 " ${LOG_LEVEL})
message(STATUS "DEBUG                     " ${DEBUG})

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${PROJECT_SOURCE_DIR}/cmake")

file(GLOB SOURCE_FILES "core/*.c" "core/mapper/*.c")

include_directories(./core/include ./core/mapper/include)

if(DEFINED WASM)
  if(NOT DEFINED ENV{EMSCRIPTEN})
    message(FATAL_ERROR "not defined environment variable:EMSCRIPTEN")
  endif()
  include_directories(ENV{EMSCRIPTEN}/system/include)
  file(GLOB TARGET_FILES "targets/wasm/*.c")
  set(SOURCE_FILES ${SOURCE_FILES} ${TARGET_FILES})
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Os")
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -s WASM=1")
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -s EXTRA_EXPORTED_RUNTIME_METHODS='[\"cwrap\"]'")
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -s ALLOW_MEMORY_GROWTH=1")
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -s ASSERTIONS=2")
  set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${OUTPUT_DIR})
  add_definitions(-DWASM)
elseif(DEFINED TEST)
  if("${TEST}" STREQUAL "CPU")
    set(SOURCE_FILES ${SOURCE_FILES} ${CMAKE_CURRENT_SOURCE_DIR}/tests/test-cpu-nestest.c)
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${OUTPUT_DIR})
    add_definitions(-DTEST_CPU)
  endif()
else()
  file(GLOB TARGET_FILES "targets/native/*.c")
  set(SOURCE_FILES ${SOURCE_FILES} ${TARGET_FILES})
  set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${OUTPUT_DIR})
endif()

add_executable(${PROJECT_NAME} ${SOURCE_FILES})
